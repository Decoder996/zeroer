# ZeroER 问题诊断与解决方案

## 问题总结

你遇到的主要问题：
1. **运行速度特别慢**
2. **效果很差，F1 极低**

## ZeroER 工作原理

ZeroER 是一个**无监督**的实体解析方法，核心流程：

1. **Blocking（分块）**：使用 Magellan 生成候选对，减少需要比较的记录对数量
2. **特征提取**：使用 Magellan 提取相似度特征（如 Jaccard、Cosine、Levenshtein 等）
3. **特征过滤**：只保留相似度特征（值在 [0,1] 范围），去除距离特征
4. **初始化**：使用阈值方法初始化正负样本
5. **EM 算法**：使用高斯混合模型迭代优化，找到匹配的记录对

## 可能的问题原因

### 问题 1: 运行速度慢

**主要原因：**
- **候选对数量太多**：blocking 太宽松，生成了太多候选对
- **特征数量太多**：提取的特征太多，EM 算法计算量大
- **EM 算法复杂度高**：每次迭代需要计算协方差矩阵，复杂度 O(n×m²)

**解决方案：**

1. **改进 Blocking**：
   ```python
   # 在 blocking_functions.py 中，增加 overlap_size
   # 例如，从 overlap_size=1 改为 overlap_size=2 或 3
   C = ob.block_tables(A, B, 'name', 'name', 
                       overlap_size=2,  # 增加这个值
                       word_level=True, 
                       show_progress=True)
   ```

2. **检查候选对数量**：
   ```python
   # 在 zeroer.py 中添加
   print(f"候选对数量: {len(candset_df):,}")
   # 如果超过 10 万，考虑改进 blocking
   ```

3. **不使用 transitivity**：
   ```bash
   # 如果不需要，不要使用 --run_transitivity
   python zeroer.py <dataset>  # 而不是 --run_transitivity
   ```

### 问题 2: F1 分数极低

**主要原因：**

#### 原因 1: 特征提取问题（最可能）

如果你从 deepmatcher 拷贝了特征提取代码，可能存在以下问题：
- 特征格式不对
- 特征值不在 [0,1] 范围
- 缺少必要的特征过滤

**解决方案：**

1. **确保使用 ZeroER 原版的特征提取代码**：
   - 使用 `data_loading_helper/feature_extraction.py`
   - 使用 `data_loading_helper/magellan_modified_feature_generation.py`
   - **不要**使用 deepmatcher 的特征提取代码

2. **检查特征值范围**：
   ```python
   # 在 zeroer.py 的 gather_similarity_features 之后添加
   print("特征值范围:")
   print(f"最小值: {similarity_features_df.min().min()}")
   print(f"最大值: {similarity_features_df.max().max()}")
   
   # 如果不在 [0,1] 范围，需要归一化
   if similarity_features_df.min().min() < 0 or similarity_features_df.max().max() > 1:
       from sklearn.preprocessing import MinMaxScaler
       scaler = MinMaxScaler()
       similarity_features_df = pd.DataFrame(
           scaler.fit_transform(similarity_features_df),
           columns=similarity_features_df.columns,
           index=similarity_features_df.index
       )
   ```

3. **检查特征过滤**：
   确保 `gather_similarity_features` 正确过滤了：
   - 距离特征：`lev_dist`, `rdf`
   - 非归一化特征：`aff`, `sw`, `swn`, `nmw`

#### 原因 2: 初始化问题

初始化阈值（默认 0.8）可能不适合你的数据集。

**解决方案：**

```python
# 在 utils.py 的 run_zeroer 函数中，调整阈值
y_init = get_y_init_given_threshold(similarity_features_df, threshold=0.6)  # 降低阈值
# 或者
y_init = get_y_init_given_threshold(similarity_features_df, threshold=0.5)  # 进一步降低
```

#### 原因 3: Blocking 质量

Blocking 太严格或太宽松都会影响效果。

**解决方案：**

```python
# 检查 blocking 质量
if 'gold' in candset_df.columns:
    pos_ratio = candset_df['gold'].sum() / len(candset_df)
    print(f"正样本比例: {pos_ratio:.4f}")
    
    # 如果比例 < 0.001，blocking 太宽松
    # 如果比例 > 0.1，blocking 太严格
    # 理想范围：0.001 - 0.1
```

#### 原因 4: c_bay 参数

`c_bay` 参数控制协方差矩阵的正则化，可能影响效果。

**解决方案：**

```python
# 在 utils.py 中，尝试不同的值
c_bay = 0.015  # 论文中的默认值
# 或
c_bay = 0.1    # 当前代码中的值
# 或
c_bay = 0.05   # 中间值
```

## 诊断步骤

### 步骤 1: 运行诊断脚本

```bash
python diagnose_zeroer.py <your_dataset>
```

这会检查：
- 特征文件是否存在
- 特征统计信息
- 是否有 NaN/Inf 值
- 初始化质量
- Blocking 质量

### 步骤 2: 检查特征

```python
import pandas as pd
from data_loading_helper.feature_extraction import gather_similarity_features

df = pd.read_csv('datasets/<your_dataset>/candset_features_df.csv', index_col=0)
similarity_df = gather_similarity_features(df)

# 检查特征范围
print("特征统计:")
print(similarity_df.describe())
print(f"\n最小值: {similarity_df.min().min()}")
print(f"最大值: {similarity_df.max().max()}")

# 检查 NaN
print(f"\nNaN 数量: {similarity_df.isna().sum().sum()}")
```

### 步骤 3: 检查 Blocking

```python
# 在 zeroer.py 中添加
print(f"候选对数量: {len(candset_df):,}")

if duplicates_df is not None:
    total_positives = len(duplicates_df)
    print(f"真实匹配数量: {total_positives}")
    print(f"Blocking 召回率: {candset_df.merge(duplicates_df, on=['ltable_id','rtable_id']).shape[0] / total_positives * 100:.2f}%")
```

### 步骤 4: 检查初始化

```python
# 在 model.py 的 get_y_init_given_threshold 函数中添加
y_init = get_y_init_given_threshold(similarity_features_df, threshold=0.8)
print(f"初始化正样本数量: {sum(y_init)}")
print(f"初始化正样本比例: {sum(y_init)/len(y_init)*100:.2f}%")
```

## 快速修复建议

### 修复 1: 确保特征归一化

在 `zeroer.py` 中，`gather_similarity_features` 之后添加归一化：

```python
similarity_features_df = gather_similarity_features(candset_features_df)

# 添加特征归一化（如果不在 [0,1] 范围）
from sklearn.preprocessing import MinMaxScaler
if similarity_features_df.min().min() < 0 or similarity_features_df.max().max() > 1:
    print("特征值不在 [0,1] 范围，进行归一化...")
    scaler = MinMaxScaler()
    similarity_features_df = pd.DataFrame(
        scaler.fit_transform(similarity_features_df),
        columns=similarity_features_df.columns,
        index=similarity_features_df.index
    )
```

### 修复 2: 调整初始化阈值

在 `utils.py` 的 `run_zeroer` 函数中：

```python
# 尝试不同的阈值
y_init = get_y_init_given_threshold(similarity_features_df, threshold=0.6)
```

### 修复 3: 调整 c_bay 参数

在 `utils.py` 中：

```python
c_bay = 0.015  # 使用论文中的默认值，而不是 0.1
```

### 修复 4: 改进 Blocking

在 `blocking_functions.py` 中，为你的数据集添加合适的 blocking 函数：

```python
def block_your_dataset(A, B):
    ob = em.OverlapBlocker()
    # 根据你的数据调整 overlap_size
    # 如果候选对太多，增加 overlap_size
    # 如果候选对太少，减少 overlap_size
    C = ob.block_tables(A, B, 'key_column', 'key_column', 
                        word_level=True, 
                        overlap_size=2,  # 调整这个值
                        show_progress=True)
    return C
```

## 常见错误

### 错误 1: 使用 DeepMatcher 的特征提取代码

**症状**：特征格式不对，F1 极低

**解决**：使用 ZeroER 原版的 Magellan 特征提取代码

### 错误 2: 特征值不在 [0,1] 范围

**症状**：EM 算法不收敛，F1 极低

**解决**：添加特征归一化

### 错误 3: Blocking 太宽松

**症状**：候选对数量巨大，运行极慢

**解决**：增加 `overlap_size`，使用更严格的 blocking

### 错误 4: 初始化正样本太少

**症状**：EM 算法无法找到正样本

**解决**：降低初始化阈值

## 调试建议

1. **先用 fodors_zagats 数据集测试**：确保代码能正常运行
2. **逐步调试**：
   - 先检查 blocking 是否正确
   - 再检查特征提取是否正确
   - 最后检查 EM 算法
3. **添加日志**：在关键步骤添加 print 语句
4. **对比 fodors_zagats**：如果你的数据集效果差，对比一下 fodors_zagats 的特征和你的特征有什么不同

## 参考文档

- 详细分析：`ZEROER_ANALYSIS.md`
- 诊断脚本：`diagnose_zeroer.py`
- ZeroER 论文：https://arxiv.org/abs/1908.06049

